<!DOCTYPE html>
<html lang="en">
  <meta charset="utf-8" />
  <title>Calendar: Canvas</title>
  <style>
    * {
      font-size: 1em;
      font-weight: 400;
      margin: 0;
      padding: 0;
    }
    :root {
      font-family: system-ui, sans-serif;
      font-size: calc(max(100%, min(2vw, 150%)));
      line-height: 1.5;
      color: white;
      background: color-mix(in srgb, crimson 4%, black);
    }
    body {
      margin: 1lh;
    }
    calendar-canvas {
      display: block;
      max-width: min-content;
      margin: auto;
      text-align: center;

      &:hover {
        box-shadow: 0 0 1px 1px blue;
      }

      header {
        position: relative;

        button {
          position: absolute;
          top: 0;
          height: 100%;
          font-size: 1em;
          padding: 0;
          color: crimson;
          background: transparent;
          border: 0;
        }
        button[name="previous"] {
          left: 0;
        }
        button[name="next"] {
          right: 0;
        }
      }
    }
  </style>
  <script type="module">
    const fontBase = "1em system-ui";
    const fontItalic = `italic ${fontBase}`;

    function isLeapYear(year) {
      return year % 4 === 0 && (year % 100 !== 0 || year % 400 === 0);
    }

    function daysInMonth(year, month) {
      switch (month) {
        case 2:
          return isLeapYear(year) ? 29 : 28;
        case 4:
        case 6:
        case 9:
        case 11:
          return 30;
        default:
          return 31;
      }
    }

    function dayOfWeek(year, month, day) {
      if (month < 3) {
        month = month + 12;
        year = year - 1;
      }

      return (
        (day +
          Math.floor(2.6 * (month + 1)) +
          year +
          Math.floor(year / 4) -
          Math.floor(year / 100) +
          Math.floor(year / 400) +
          6) %
          7 || 7
      );
    }

    class CalendarState {
      constructor(year, month) {
        this.year = year;
        this.month = month;
        Object.freeze(this);
      }

      previous() {
        return this.month === 1
          ? new CalendarState(this.year - 1, 12)
          : new CalendarState(this.year, this.month - 1);
      }

      next() {
        return this.month === 12
          ? new CalendarState(this.year + 1, 1)
          : new CalendarState(this.year, this.month + 1);
      }
    }

    const monthYearFormatter = new Intl.DateTimeFormat(undefined, {
      month: "long",
      year: "numeric",
    });

    const weekdayFormatter = new Intl.DateTimeFormat(undefined, {
      weekday: "short",
    });

    function renderCalendar(canvas, year, month, { lh, dpr }) {
      const firstWeekday = dayOfWeek(year, month, 1);
      const totalDays = daysInMonth(year, month);
      const totalWeeks = Math.ceil((totalDays + firstWeekday - 1) / 7);

      const c = canvas.getContext("2d");
      let ch = 16;
      {
        c.font = fontBase;
        ch = c.measureText("0").width;

        const columns = 2 * 0.5 + 4 * 7;
        const lineCount = totalWeeks + 1;
        canvas.width = columns * ch * dpr;
        canvas.height = lineCount * lh * dpr;
        if (dpr > 1) {
          canvas.style.width = `${columns}ch`;
          canvas.style.height = `${lineCount}lh`;
        }
      }

      c.clearRect(0, 0, canvas.width, canvas.height);

      c.textAlign = "center";
      c.textBaseline = "middle";

      c.scale(dpr, dpr);

      {
        c.font = fontItalic;
        c.textAlign = "center";
        c.fillStyle = "crimson";

        for (let weekday = 1; weekday <= 7; weekday++) {
          c.fillText(
            weekdayFormatter.format(new Date(2000, 0, 2 + weekday)),
            (2.5 + 4 * (weekday - 1)) * ch,
            0.5 * lh
          );
        }
      }

      {
        c.strokeStyle = "crimson";
        c.beginPath();

        for (let week = 1; week <= totalWeeks; week++) {
          c.moveTo(0, week * lh);
          c.lineTo(100_000_000, week * lh);
          c.stroke();
        }
      }

      {
        c.font = fontBase;
        c.textAlign = "center";
        c.fillStyle = "white";

        for (let day = 1; day <= totalDays; day++) {
          const weekOffset = 1 + Math.floor((day + firstWeekday - 2) / 7);

          c.fillText(
            `${day}`,
            (2.5 + 4 * ((day + firstWeekday - 2) % 7)) * ch,
            (0.5 + weekOffset) * lh
          );
        }
      }
    }

    class CalendarCanvas extends HTMLElement {
      connectedCallback() {
        const today = new Date();
        const state = new CalendarState(
          today.getFullYear(),
          today.getMonth() + 1
        );
        this.state = state;

        const d = this.ownerDocument;
        const content = d
          .querySelector("template#calendar-canvas")
          .content.cloneNode(true);

        const canvas = d.createElement("canvas");
        this.append(content, canvas);

        this.update();

        this.addEventListener("click", this);

        const ro = new ResizeObserver((_entries) => {
          requestAnimationFrame(() => this.update());
        });

        ro.observe(canvas);
        this.ro = ro;
      }

      disconnectedCallback() {
        this.removeEventListener("click", this);
        this.ro.disconnect();
      }

      update() {
        const { year, month } = this.state;

        const d = this.ownerDocument;
        const w = d.defaultView || window;
        const canvas = this.querySelector("canvas");

        const monthYear = monthYearFormatter.format(new Date(year, month - 1));
        this.querySelector("h2").replaceChildren(monthYear);

        const lh = parseFloat(w.getComputedStyle(this).lineHeight);
        const dpr = w.devicePixelRatio;

        renderCalendar(canvas, year, month, { lh, dpr });
      }

      handleEvent(event) {
        const button = event.target.closest("button");
        if (button && event.type === "click") {
          if (button.name === "previous") {
            this.state = this.state.previous();
          } else if (button.name === "next") {
            this.state = this.state.next();
          }

          this.update();
        }
      }
    }
    customElements.define("calendar-canvas", CalendarCanvas);
  </script>
  <body>
    <template id="calendar-canvas">
      <header>
        <button type="button" name="previous" aria-label="Previous month">
          <svg
            width="1em"
            height="1em"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="m15 18-6-6 6-6" />
          </svg>
        </button>
        <h2>November 2025</h2>
        <button type="button" name="next" aria-label="Next month">
          <svg
            width="1em"
            height="1em"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="m9 18 6-6-6-6" />
          </svg>
        </button>
      </header>
    </template>
    <calendar-canvas></calendar-canvas>
  </body>
</html>
