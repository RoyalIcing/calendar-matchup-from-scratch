<!DOCTYPE html>
<html lang="en">
  <meta charset="utf-8" />
  <title>Calendar: Grid</title>
  <style>
    * {
      font-size: 1em;
      font-weight: 400;
      margin: 0;
      padding: 0;
    }
    :root {
      font-family: system-ui, sans-serif;
      font-size: calc(max(100%, min(2vw, 150%)));
      line-height: 1.5;
      color: white;
      background: color-mix(in srgb, crimson 4%, black);
    }
    body {
      margin: 1lh;
    }
    calendar-grid {
      display: block;
      max-width: min-content;
      margin: auto;
      text-align: center;

      &:hover {
        box-shadow: 0 0 1px 1px blue;
      }

      header {
        position: relative;

        button {
          position: absolute;
          top: 0;
          height: 100%;
          font-size: 1em;
          padding: 0;
          color: crimson;
          background: transparent;
          border: 0;
        }
        button[name="previous"] {
          left: 0;
        }
        button[name="next"] {
          right: 0;
        }
      }

      section {
        overflow: hidden;
        display: grid;
        grid-template-columns: repeat(7, 1fr);

        > * {
          padding: 0 0.5em;
          border-bottom: 1px solid crimson;
          margin-bottom: -1px;
        }

        calendar-weekday {
          color: crimson;
          font-style: italic;
        }
      }
    }
  </style>
  <script type="module">
    function isLeapYear(year) {
      return year % 4 === 0 && (year % 100 !== 0 || year % 400 === 0);
    }

    function daysInMonth(year, month) {
      switch (month) {
        case 2:
          return 28 + (isLeapYear(year) ? 1 : 0);
        case 4:
        case 6:
        case 9:
        case 11:
          return 30;
        default:
          return 31;
      }
    }

    function dayOfWeek(year, month, day) {
      if (month < 3) {
        month = month + 12;
        year = year - 1;
      }

      const k = year % 100;
      const j = Math.floor(year / 100);

      const weekday =
        (day +
          Math.floor((13 * (month + 1)) / 5) +
          k +
          Math.floor(k / 4) +
          Math.floor(j / 4) +
          5 * j) %
        7;

      // Adjust the result to make Sunday 0 instead of Saturday 0
      return ((weekday + 5) % 7) + 1;
    }

    function* renderDays(d, year, month) {
      // const weekdayFormatter = new Intl.DateTimeFormat(undefined, {
      //   weekday: "short",
      // });
      // yield* Array.from({ length: 7 }, (_, offset) => {
      //   const el = d.createElement("calendar-weekday");
      //   el.textContent = weekdayFormatter.format(new Date(2000, 0, 3 + offset));
      //   return el;
      // });

      let weekdayOfFirstDay = dayOfWeek(year, month, 1);
      while (weekdayOfFirstDay > 1) {
        yield d.createElement("div");
        weekdayOfFirstDay--;
      }

      const totalDays = daysInMonth(year, month);

      for (let day = 1; day <= totalDays; day++) {
        const cell = d.createElement("div");
        cell.textContent = `${day}`;
        yield cell;
      }
    }

    class CalendarState {
      constructor(year, month) {
        Object.freeze(Object.assign(this, { year, month }));
      }

      previous() {
        const year = this.year - (this.month === 1 ? 1 : 0);
        const month = this.month === 1 ? 12 : this.month - 1;
        return new CalendarState(year, month);
      }

      next() {
        const year = this.year + (this.month === 12 ? 1 : 0);
        const month = this.month === 12 ? 1 : this.month + 1;
        return new CalendarState(year, month);
      }
    }

    const monthYearFormatter = new Intl.DateTimeFormat(undefined, {
      month: "long",
      year: "numeric",
    });

    class CalendarGrid extends HTMLElement {
      connectedCallback() {
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth() + 1;

        const state = new CalendarState(year, month);
        this.state = state;

        const content = this.ownerDocument
          .querySelector("template#calendar-grid")
          .content.cloneNode(true);

        this.append(content);

        this.update();

        this.addEventListener("click", this);
      }

      disconnectedCallback() {
        this.removeEventListener("click", this);
      }

      update() {
        const { year, month } = this.state;

        const monthYear = monthYearFormatter.format(new Date(year, month - 1));

        this.querySelector("h2").replaceChildren(monthYear);

        const section = this.querySelector("section");

        section.replaceChildren(
          ...section.querySelectorAll("calendar-weekday"),
          ...renderDays(this.ownerDocument, year, month)
        );
      }

      handleEvent(event) {
        const button = event.target.closest("button");
        if (button && event.type === "click") {
          if (button.name === "previous") {
            this.state = this.state.previous();
          } else if (button.name === "next") {
            this.state = this.state.next();
          }

          this.update();
        }
      }
    }
    customElements.define("calendar-grid", CalendarGrid);
  </script>
  <body>
    <template id="calendar-grid">
      <header>
        <button type="button" name="previous">
          <svg
            width="1em"
            height="1em"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="m15 18-6-6 6-6" />
          </svg>
        </button>
        <h2>November 2025</h2>
        <button type="button" name="next">
          <svg
            width="1em"
            height="1em"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="m9 18 6-6-6-6" />
          </svg>
        </button>
      </header>
      <section>
        <calendar-weekday>Mon</calendar-weekday>
        <calendar-weekday>Tue</calendar-weekday>
        <calendar-weekday>Wed</calendar-weekday>
        <calendar-weekday>Thu</calendar-weekday>
        <calendar-weekday>Fri</calendar-weekday>
        <calendar-weekday>Sat</calendar-weekday>
        <calendar-weekday>Sun</calendar-weekday>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div>1</div>
        <div>2</div>
        <div>3</div>
        <div>4</div>
        <div>5</div>
        <div>6</div>
        <div>7</div>
        <div>8</div>
        <div>9</div>
        <div>10</div>
        <div>11</div>
        <div>12</div>
        <div>13</div>
        <div>14</div>
        <div>15</div>
        <div>16</div>
        <div>17</div>
        <div>18</div>
        <div>19</div>
        <div>20</div>
        <div>21</div>
        <div>22</div>
        <div>23</div>
        <div>24</div>
        <div>25</div>
        <div>26</div>
        <div>27</div>
        <div>28</div>
        <div>29</div>
        <div>30</div>
        <div>31</div>
      </section>
    </template>

    <calendar-grid></calendar-grid>
  </body>
</html>
